import{r as c,c as C,o as V,a as n,b as r,t as s,s as _,E as F,F as h,f as D,v as N,e as M,n as R,J as E,g as L,j as d}from"./vue-CbfYRXie.js";import{a as v}from"./network-QpDy7ETe.js";const U={class:"p-6 font-nanum"},$={class:"mb-6 p-4 bg-purple-50 border border-purple-300 rounded text-xl font-bold text-purple-800 shadow-sm"},j={class:"mb-6 flex flex-wrap items-end gap-6"},z=["value"],A={class:"w-full border text-sm mb-6"},O={class:"border p-2"},G={class:"border p-2 text-center font-mono"},J={class:"border p-2 text-center"},K={class:"border p-2 text-center"},Y={class:"border p-2 text-center"},q={class:"border p-2 text-right font-mono"},H=["value","onInput"],P={key:0},Z={__name:"BudgetsGrid",setup(Q){const g=c([]),u=c(null),i=c([]),y=c(new Date().toISOString().split("T")[0]),m=c(new Date().getFullYear()),p=c({}),w=C(()=>{const o=(t,e=null,a=1)=>t.filter(l=>l.parent_id===e).map(l=>({...l,depth:a,children:o(t,l.id,a+1)})).flatMap(l=>[l,...l.children]);return o(i.value)}),B=C(()=>i.value.filter(t=>t.parent_id===null).reduce((t,e)=>t+b(e.id),0));V(async()=>{const o=await v.get("/api/departments");g.value=o.data,g.value.length>0&&(u.value=g.value[0].id,f())});const f=async()=>{if(u.value)try{const o=await v.get(`/api/accountCategories/${u.value}`,{params:{date:y.value}});i.value=o.data.categories||[];const t=await v.get(`/api/budgets/${u.value}`,{params:{year:m.value}});p.value={},t.data.budgets.forEach(e=>{p.value[e.category_id]=Number(e.budget_amount)||0})}catch{}},I=o=>{const t=i.value.find(e=>e.id===o);return t?t.category_name:"-"},k=o=>o?new Date(o).toISOString().split("T")[0]:"",S=async()=>{try{const o=i.value.map(t=>{var e;return{dept_id:u.value,category_id:t.category_id,year:m.value,budget_amount:t.level==="세목"?(e=p.value[t.category_id])!=null?e:0:b(t.id)}});await v.post("/api/budgets/bulk",{budgets:o}),alert("💾 예산이 저장되었습니다.")}catch{alert("❌ 저장 실패")}},T=(o,t)=>{const e=o.target.value.replace(/[^0-9]/g,"");p.value[t.category_id]=e?Number(e):0},b=o=>i.value.filter(e=>e.parent_id===o).reduce((e,a)=>{var l;return a.level==="세목"?e+=Number((l=p.value[a.category_id])!=null?l:0):e+=b(a.id),e},0),x=o=>{if(o==null)return"0";const t=Number(o);return isNaN(t)?"0":t.toLocaleString("ko-KR",{maximumFractionDigits:0})};return(o,t)=>(d(),n("div",U,[t[8]||(t[8]=r("h2",{class:"text-2xl font-bold text-purple-700 mb-6"},"💰 예산 관리",-1)),r("div",$," 📊 총 예산: "+s(x(B.value))+" 원 ",1),r("div",j,[r("div",null,[t[3]||(t[3]=r("label",{class:"font-semibold text-gray-700"},"부서 선택",-1)),_(r("select",{"onUpdate:modelValue":t[0]||(t[0]=e=>u.value=e),onChange:f,class:"ml-2 border rounded p-2 shadow-sm"},[(d(!0),n(h,null,D(g.value,e=>(d(),n("option",{key:e.id,value:e.id},s(e.dept_name),9,z))),128))],544),[[F,u.value]])]),r("div",null,[t[4]||(t[4]=r("label",{class:"font-semibold text-gray-700"},"기준일자",-1)),_(r("input",{type:"date","onUpdate:modelValue":t[1]||(t[1]=e=>y.value=e),onChange:f,class:"ml-2 border rounded p-2 shadow-sm"},null,544),[[N,y.value]])]),r("div",null,[t[5]||(t[5]=r("label",{class:"font-semibold text-gray-700"},"회계연도",-1)),_(r("input",{type:"number","onUpdate:modelValue":t[2]||(t[2]=e=>m.value=e),min:"2000",max:"2100",class:"ml-2 border rounded p-2 w-28 shadow-sm"},null,512),[[N,m.value]])])]),r("table",A,[t[7]||(t[7]=r("thead",null,[r("tr",{class:"bg-purple-100 text-gray-800"},[r("th",{class:"border p-2 text-center"},"계정명"),r("th",{class:"border p-2 text-center"},"계정ID"),r("th",{class:"border p-2 text-center"},"단계"),r("th",{class:"border p-2 text-center"},"상위 계정"),r("th",{class:"border p-2 text-center"},"유효기간"),r("th",{class:"border p-2 text-center"},"예산금액")])],-1)),r("tbody",null,[(d(!0),n(h,null,D(w.value,e=>{var a;return d(),n("tr",{key:e.id,class:R({"bg-gray-100 font-bold":e.level==="관","bg-blue-50":e.level==="항","bg-green-50":e.level==="목","bg-white":e.level==="세목"})},[r("td",O,[r("span",{style:E({paddingLeft:`${(e.depth-1)*40}px`})},s(e.category_name),5)]),r("td",G,s(e.category_id||"-"),1),r("td",J,s(e.level),1),r("td",K,s(I(e.parent_id)),1),r("td",Y,s(k(e.valid_from))+" ~ "+s(e.valid_to?k(e.valid_to):"현재"),1),r("td",q,[e.level==="세목"?(d(),n("input",{key:0,type:"text",class:"border rounded p-1 w-40 text-right shadow-sm",value:x((a=p.value[e.category_id])!=null?a:0),onInput:l=>T(l,e)},null,40,H)):(d(),n(h,{key:1},[L(s(x(b(e.id))),1)],64))])],2)}),128)),w.value.length===0?(d(),n("tr",P,[...t[6]||(t[6]=[r("td",{colspan:"6",class:"text-center p-4 text-gray-500"}," 데이터가 없습니다. ",-1)])])):M("",!0)])]),r("div",{class:"flex justify-end"},[r("button",{onClick:S,class:"px-5 py-2 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-lg shadow hover:from-purple-600 hover:to-indigo-700 transition"}," 💾 저장 ")])]))}};export{Z as default};
