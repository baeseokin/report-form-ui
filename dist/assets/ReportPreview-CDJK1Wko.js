import{_ as Z}from"./pdf-BllNUW5F.js";import{u as mt}from"./index-CY_W9l9r.js";import{r as $,o as tt,c as k,a as l,j as a,b as s,t as u,s as ht,v as ft,n as et,B as bt,y as vt,k as yt,e as x,h as xt,J as M,K as wt,F as A,f as L,g as T}from"./vue-CbfYRXie.js";import{_ as _t}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{_ as kt}from"./ModalAlert-DBpkgysQ.js";import{a as $t}from"./network-QpDy7ETe.js";const Pt={class:"fixed inset-0 flex items-center justify-center bg-black/40 z-50 font-nanum"},jt={class:"bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 relative animate-fadeIn"},Dt={class:"text-xl font-bold mb-4 flex items-center justify-between"},St={class:"mb-4"},Ct={class:"mb-4"},Rt={class:"block"},At={class:"flex justify-end gap-3 mt-6"},Lt={__name:"ApprovalPopup",props:{report:Object,mode:{type:String,required:!0}},emits:["close","approved"],setup(v,{emit:N}){const F=v,D=N,p=$(""),w=$(null);let g=null,E=!1;tt(()=>{const n=w.value,d=n.getBoundingClientRect(),c=window.devicePixelRatio||1;n.width=d.width*c,n.height=d.height*c,g=n.getContext("2d"),g.scale(c,c),g.strokeStyle="#000",g.lineWidth=2;const _=m=>{const f=n.getBoundingClientRect();return m.touches&&m.touches[0]?{x:m.touches[0].clientX-f.left,y:m.touches[0].clientY-f.top}:{x:m.clientX-f.left,y:m.clientY-f.top}},P=m=>{m.preventDefault(),E=!0;const f=_(m);g.beginPath(),g.moveTo(f.x,f.y)},y=m=>{if(!E)return;m.preventDefault();const f=_(m);g.lineTo(f.x,f.y),g.stroke()},C=()=>{E=!1};n.addEventListener("mousedown",P),n.addEventListener("mousemove",y),n.addEventListener("mouseup",C),n.addEventListener("mouseleave",C),n.addEventListener("touchstart",P,{passive:!1}),n.addEventListener("touchmove",y,{passive:!1}),n.addEventListener("touchend",C),n.addEventListener("touchcancel",C)});const W=()=>{g.clearRect(0,0,w.value.width,w.value.height)},S=k(()=>F.mode==="approve"?"승인":"반려"),H=async()=>{const n=w.value;if(!n){alert("서명 캔버스가 초기화되지 않았습니다.");return}if(g&&g.getImageData(0,0,n.width,n.height).data.every(c=>c===0)){alert("서명을 입력해주세요.");return}n.toBlob(async d=>{if(!d){alert("서명 데이터가 비어 있습니다.");return}const c=new FormData;c.append("requestId",F.report.id),c.append("comment",p.value),c.append("signature",d,"signature.png");const _=F.mode==="approve"?"/api/approval/approve":"/api/approval/reject";try{const y=await(await fetch(_,{method:"POST",body:c,credentials:"include"})).json();y.success?(D("approved"),D("close")):alert(`${S.value} 실패: ${y.message||""}`)}catch{alert(`${S.value} 오류 발생`)}})};return(n,d)=>(a(),l("div",Pt,[s("div",jt,[s("h2",Dt,[s("span",null,"결재 처리 ("+u(S.value)+")",1),s("button",{onClick:d[0]||(d[0]=c=>n.$emit("close")),class:"text-gray-400 hover:text-black text-2xl leading-none"}," ✕ ")]),s("div",St,[d[3]||(d[3]=s("span",{class:"text-gray-700 font-medium block mb-2"},"서명",-1)),s("canvas",{ref_key:"signaturePad",ref:w,class:"border rounded-lg w-full h-40 bg-gray-50"},null,512),s("div",{class:"flex justify-end mt-2"},[s("button",{onClick:W,class:"px-3 py-1 bg-gray-200 text-gray-600 rounded hover:bg-gray-300"}," 서명 지우기 ")])]),s("div",Ct,[s("label",Rt,[d[4]||(d[4]=s("span",{class:"text-gray-700 font-medium"},"결재 의견",-1)),ht(s("textarea",{"onUpdate:modelValue":d[1]||(d[1]=c=>p.value=c),class:"w-full mt-2 border rounded-lg p-2 focus:ring-2 focus:ring-purple-400 focus:outline-none",rows:"3",placeholder:"의견을 입력하세요..."},null,512),[[ft,p.value]])])]),s("div",At,[s("button",{onClick:d[2]||(d[2]=c=>n.$emit("close")),class:"px-5 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition"}," 취소 "),s("button",{onClick:H,class:et(["px-5 py-2 rounded-lg text-white font-semibold shadow-md transition",v.mode==="approve"?"bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700":"bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700"])}," 처리 ",2)])])]))}},Ft=_t(Lt,[["__scopeId","data-v-32a58164"]]),Et={class:"fixed flex items-center justify-center inset-0 bg-black bg-opacity-50 z-50 font-nanum"},Wt={class:"bg-white rounded-2xl w-full sm:max-w-[52rem] h-screen p-0 relative overflow-y-auto border-t-8 border-purple-500 transform sm:scale-100 origin-top"},Tt={class:"title-lg text-center mb-6 text-gray-800 mt-4"},Ht={class:"flex justify-between mb-6"},It={class:"w-2/5 border text-center table-fixed"},Mt={class:"bg-purple-100 text-gray-700"},Nt={class:"h-24"},Ut={class:"flex flex-col items-center justify-center"},Bt=["src"],Vt=["onMouseenter"],zt={key:0,class:"absolute left-1/2 transform -translate-x-1/2 mt-2 bg-white border border-gray-300 shadow-lg rounded p-2 text-xs w-44 z-50 no-print"},Ot={key:2,class:"text-gray-500 text-xs mt-1"},qt={class:"w-full border text-center mb-4"},Yt={class:"border"},Gt={class:"w-full border my-4 text-center"},Kt={class:"border"},Xt={class:"border"},Jt={class:"border"},Qt={class:"border"},Zt={class:"border"},te={class:"border text-right"},ee={key:0},se={class:"bg-blue-100 font-bold"},oe={class:"border text-right"},re={class:"mt-10 text-right text-xl leading-loose"},ne={class:"title-lg text-center mb-6 text-gray-800"},ae={class:"text-gray-700 font-medium mb-2 text-center break-words"},le=["src"],ie={key:1,class:"text-sm text-gray-500 italic text-center"},de={class:"fixed bottom-0 left-0 w-full bg-gradient-to-r from-purple-100 via-pink-100 to-sky-100 border-t border-gray-200 shadow-inner z-50 no-print"},ce={class:"hidden sm:flex justify-center items-center gap-x-5 py-3 px-6"},ue={class:"flex sm:hidden flex-col gap-3 px-6 py-4"},pe={key:0,class:"flex justify-around gap-4"},B=650,ge=1500,we={__name:"ReportPreview",props:["report"],emits:["close","refreshList"],setup(v,{emit:N}){var J;const F=bt(),D=k(()=>F.path.startsWith("/approvalStatus")),p=v,w=N,{user:g}=vt(mt()),E=k(()=>{var o,t;return((o=g.value)==null?void 0:o.deptName)||((t=p.report)==null?void 0:t.deptName)||""});k(()=>{var o,t;return((o=g.value)==null?void 0:o.userName)||((t=p.report)==null?void 0:t.author)||""});const W=$(1),S=k(()=>({transform:`scale(${W.value})`,transformOrigin:"top center",width:"210mm",minHeight:"297mm"}));tt(()=>{const t=window.innerWidth;t<768?W.value=1:W.value=t<794?t/794:1});const H=["회계","부장","위원장","당회장"],n=$(!1),d=$(!1),c=$(((J=p.report)==null?void 0:J.approvalHistory)||[]),_=$(null),P=$(null),y=o=>{P.value=o,n.value=!0},C=()=>{n.value=!1},m=async()=>{var o;if((o=p.report)!=null&&o.id)try{const t=await $t.get(`/api/approval/detail/${p.report.id}`,{withCredentials:!0});c.value=t.data.approvalHistory||[]}catch{}},f=async()=>{await m(),n.value=!1,d.value=!0,w("refreshList")},st=()=>{d.value=!1,w("close")},V=o=>!o&&o!==0?"":Number(o).toLocaleString("ko-KR"),z=o=>{var t;return((t=c.value.find(e=>e.approver_role===o))==null?void 0:t.signature_path)||null},O=o=>{var t;return((t=c.value.find(e=>e.approver_role===o))==null?void 0:t.comment)||null},ot=o=>{const t=z(o);return t?`/api/files/${t}`:""},q=o=>{var t;return((t=c.value.find(e=>e.approver_role===o))==null?void 0:t.approved_at)||null},rt=o=>{if(!o)return"";const t=new Date(o),e=String(t.getFullYear()).slice(-2),r=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0"),b=String(t.getHours()).padStart(2,"0"),h=String(t.getMinutes()).padStart(2,"0");return`${e}/${r}/${i} ${b}:${h}`},U=o=>{const t=c.value.find(e=>e.approver_role===o);return t?t.approver_role==="회계"?"기안":t.status||null:null},nt=k(()=>{var t;const o=(((t=p.report)==null?void 0:t.items)||[]).map(e=>({gwan:e.gwan,hang:e.hang,mok:e.mok==="__custom__"?e.customMok:e.mok,semok:e.semok==="__custom__"?e.customSemok:e.semok,detail:e.detail==="__custom__"?e.customDetail:e.detail,amount:e.amount}));return o.length>=8?o:[...o,...Array(8-o.length).fill({gwan:"",hang:"",mok:"",semok:"",detail:"",amount:null})]}),at=k(()=>{var o,t,e;return(t=(o=p.report)==null?void 0:o.attachedFiles)!=null&&t.length?p.report.attachedFiles:((e=p.report)==null?void 0:e.files)||[]}),Y=k(()=>{const o=at.value,t=[];let e=[],r=0,i=[],b=0;const h=800,j=()=>{i.length&&(e.push(i),i=[],b=0,r+=h)},I=()=>{e.length&&(t.push(e),e=[],r=0)};return o.forEach(R=>{const Q=(R.height||1e3)>(R.width||600)?300:700,gt=G(R)?h:200;r+gt>ge&&(j(),I()),b+Q>B&&j(),i.push(R),b+=Q}),i.length&&j(),e.length&&I(),t}),lt=o=>{const t=o.alias_name||o.file_name||o.name||"첨부파일";return t.length>20?t.slice(0,17)+"...":t},G=o=>{var t;return((t=o.type)==null?void 0:t.startsWith("image/"))||/\.(png|jpe?g|gif)$/i.test(o.name||o.file_name||"")},it=o=>o.file?URL.createObjectURL(o.file):o.file_path?`/api/files/${encodeURIComponent(o.file_path)}`:"",dt=o=>o?new Date(o).toISOString().split("T")[0]:"",ct=(o,t,e=[])=>{if(t===1){const r=o.width||800,i=Math.min(1,B/r);return{maxWidth:`${r*i}px`,maxHeight:"1000px",objectFit:"contain"}}else if(t===2&&e.length===2){const r=e[0].width||600,i=e[1].width||600,b=r+i,h=Math.min(1,B/b);return{maxWidth:`${(o.width||600)*h}px`,maxHeight:"900px",objectFit:"contain"}}return{}},ut=o=>o===1?{width:"100%",textAlign:"center"}:{width:"45%"},K=async()=>{const{default:o}=await Z(async()=>{const{default:r}=await import("./pdf-BllNUW5F.js").then(i=>i.j);return{default:r}},[]),t=new o("p","mm","a4"),e=document.querySelectorAll(".page");for(let r=0;r<e.length;r++){const i=await(await Z(async()=>{const{default:I}=await import("./pdf-BllNUW5F.js").then(R=>R.h);return{default:I}},[])).default(e[r],{scale:2}),b=i.toDataURL("image/png"),h=t.internal.pageSize.getWidth(),j=i.height*h/i.width;r>0&&t.addPage(),t.addImage(b,"PNG",0,0,h,j)}return t},X=async()=>{(await K()).save(`${p.report.documentType}_${E.value}_${p.report.date}.pdf`)},pt=async()=>{const t=(await K()).output("blob"),e=URL.createObjectURL(t);let r=document.getElementById("pdfPrintFrame");r||(r=document.createElement("iframe"),r.id="pdfPrintFrame",r.style.position="fixed",r.style.right="0",r.style.bottom="0",r.style.width="0",r.style.height="0",r.style.border="0",document.body.appendChild(r)),r.src=e,r.onload=()=>{r.contentWindow.focus(),r.contentWindow.print()}};return(o,t)=>(a(),l("div",Et,[s("button",{onClick:t[0]||(t[0]=e=>o.$emit("close")),class:"fixed top-4 right-4 z-50 text-gray-500 hover:text-black text-2xl bg-white rounded-full w-10 h-10 flex items-center justify-center shadow"}," ✕ "),s("div",Wt,[v.report?(a(),l("div",{key:0,class:"page report-content break-before-page",ref:"reportContent",style:M(S.value)},[s("h2",Tt,u(v.report.documentType),1),s("div",Ht,[s("table",It,[s("thead",Mt,[s("tr",null,[(a(),l(A,null,L(H,e=>s("th",{key:e,class:"border"},u(e==="회계"?"담당":e),1)),64))])]),s("tbody",null,[s("tr",Nt,[(a(),l(A,null,L(H,e=>s("td",{key:e,class:"border relative"},[s("div",Ut,[z(e)?(a(),l("img",{key:0,src:ot(e),class:"w-20 h-20 object-contain rounded"},null,8,Bt)):x("",!0),U(e)?(a(),l("span",{key:1,onMouseenter:r=>_.value=e,onMouseleave:t[1]||(t[1]=r=>_.value=null),class:et(["mt-2 px-2 py-1 rounded-full text-xs font-bold",U(e)==="승인"?"bg-green-100 text-green-700 border border-green-300":"bg-red-100 text-red-700 border border-red-300"])},[T(u(U(e))+" ",1),_.value===e&&O(e)?(a(),l("div",zt," 💬 "+u(O(e)),1)):x("",!0)],42,Vt)):x("",!0),q(e)?(a(),l("small",Ot,u(rt(q(e))),1)):x("",!0)])])),64))])])]),t[6]||(t[6]=wt('<table class="w-2/5 border text-center table-fixed"><thead class="bg-purple-100 text-gray-700"><tr><th class="border w-1/4">담당</th><th class="border w-1/4">부장</th><th class="border w-1/4">위원장</th><th class="border w-1/4">당회장</th></tr></thead><tbody><tr class="h-24"><td class="border"></td><td class="border"></td><td class="border"></td><td class="border"></td></tr></tbody></table>',1))]),s("table",qt,[s("tbody",null,[s("tr",null,[t[7]||(t[7]=s("td",{class:"border w-64 bg-blue-100 font-bold"},"부서명",-1)),s("td",Yt,u(v.report.deptName),1)])])]),t[13]||(t[13]=s("h3",{class:"title-md flex items-center mb-4"},[T("💸 "),s("span",{class:"ml-2"},"지출내역")],-1)),s("table",Gt,[t[9]||(t[9]=s("thead",{class:"bg-blue-100 text-gray-800"},[s("tr",null,[s("th",{class:"border"},"관"),s("th",{class:"border"},"항"),s("th",{class:"border"},"목"),s("th",{class:"border"},"세목"),s("th",{class:"border"},"지출내역"),s("th",{class:"border"},"금액")])],-1)),s("tbody",null,[(a(!0),l(A,null,L(nt.value,(e,r)=>(a(),l("tr",{key:r},[s("td",Kt,u(e.gwan),1),s("td",Xt,u(e.hang),1),s("td",Jt,u(e.mok),1),s("td",Qt,u(e.semok),1),s("td",Zt,u(e.detail),1),s("td",te,[e.amount?(a(),l("span",ee,u(V(e.amount))+" 원",1)):x("",!0)])]))),128)),s("tr",se,[t[8]||(t[8]=s("td",{colspan:"5",class:"border text-center"},"합 계",-1)),s("td",oe,u(V(v.report.totalAmount))+" 원",1)])])]),s("div",re,[t[10]||(t[10]=T(" 위의 금액을 정히 영수합니다.",-1)),t[11]||(t[11]=s("br",null,null,-1)),T(" "+u(dt(v.report.date)),1),t[12]||(t[12]=s("br",null,null,-1)),T(" 영수인 성명 : "+u(v.report.author)+" (인) ",1)])],4)):x("",!0),(a(!0),l(A,null,L(Y.value,(e,r)=>(a(),l("div",{key:"page-"+r,class:"page report-content mt-10 break-before-page",style:M(S.value)},[s("h2",ne," 📎 첨부파일 ("+u(r+1)+" / "+u(Y.value.length)+") ",1),(a(!0),l(A,null,L(e,(i,b)=>(a(),l("div",{key:"row-"+b,class:"flex justify-center gap-6 mt-8"},[(a(!0),l(A,null,L(i,(h,j)=>(a(),l("div",{key:"file-"+r+"-"+b+"-"+j,class:"flex flex-col items-center",style:M(ut(i.length))},[s("p",ae,u(lt(h)),1),G(h)?(a(),l("img",{key:0,src:it(h),style:M(ct(h,i.length,i)),class:"border rounded-lg shadow-md object-contain"},null,12,le)):(a(),l("p",ie,"(이미지 미리보기를 지원하지 않는 파일 형식입니다)"))],4))),128))]))),128))],4))),128))]),s("div",de,[s("div",ce,[D.value?(a(),l("button",{key:0,onClick:t[2]||(t[2]=e=>y("approve")),class:"px-4 py-2 rounded-lg bg-white/80 text-green-700 font-semibold shadow hover:bg-green-100 transition"}," ✅ 승인 ")):x("",!0),D.value?(a(),l("button",{key:1,onClick:t[3]||(t[3]=e=>y("reject")),class:"px-4 py-2 rounded-lg bg-white/80 text-red-700 font-semibold shadow hover:bg-red-100 transition"}," ❌ 반려 ")):x("",!0),s("button",{onClick:X,class:"px-4 py-2 rounded-lg bg-white/80 text-gray-700 font-semibold shadow hover:bg-gray-100 transition"}," 📄 PDF "),s("button",{onClick:pt,class:"hidden sm:flex items-center gap-2 bg-gradient-to-r from-gray-600 to-gray-800 text-white px-5 py-2 rounded-lg shadow-md"}," 🖨️ 프린트 ")]),s("div",ue,[D.value?(a(),l("div",pe,[s("button",{onClick:t[4]||(t[4]=e=>y("approve")),class:"flex-1 py-3 rounded-xl bg-green-500 text-white font-bold shadow hover:bg-green-600 active:scale-95 transition"}," ✅ 승인 "),s("button",{onClick:t[5]||(t[5]=e=>y("reject")),class:"flex-1 py-3 rounded-xl bg-red-500 text-white font-bold shadow hover:bg-red-600 active:scale-95 transition"}," ❌ 반려 ")])):x("",!0),s("div",{class:"flex justify-around gap-4"},[s("button",{onClick:X,class:"flex-1 py-2 rounded-lg bg-white/90 text-gray-800 font-semibold shadow hover:bg-gray-200 active:scale-95"}," 📄 PDF ")])])]),n.value?(a(),yt(Ft,{key:0,report:v.report,mode:P.value,onClose:C,onApproved:f},null,8,["report","mode"])):x("",!0),xt(kt,{visible:d.value,title:"알림",message:"정상적으로 결재되었습니다.",onClose:st},null,8,["visible"])]))}};export{we as default};
